<?xml version="1.0" encoding="UTF-8"?>
<forth xmlns="http://forth.org.ru/ForthML/">

<comment>
  bind-up: process
</comment>


<def name="cmd-prefix">
  <slit>
    <choose> OS-WINDOWS? <when><text>cmd /c </text></when> 0. </choose>
  </slit>
</def>

<template name="compose-commandline" in=" d-txt-transform ">
  <g><ss> cmd-prefix </ss>saxon -s:- -xsl:<ss/></g>
</template>


<comment>
  When Saxon is called from WineHQ under Linux, it doesn't wait for the input more than 50 ms.
  Saxon shows error SXXP0003 "Premature end of file".
  It seems that Wine prematurely closes Saxon's input pipe end.

  As temporary workaround, now we start the process when the data are ready only,
  i.e. on the first put.
</comment>

<vect-enum> put </vect-enum>

<def name="first-put" ds=" addr u -- ">
  process::start-simple
  'process::put put! process::put
</def>

<def name="assume-transform" ds=" d-txt-filename -- ">
  process::clear
  compose-commandline process::assume-commandline
  'first-put put!
</def>

<def name="transmit-result-per" ds=" consumer-xt -- ">
  process::assume-consumer
  process::transmit-stdout
</def>

<def name="close" ds=" -- ">
  process::p-handle <unless-exit/>
  process::exitcode-sure
  process::clear
  DUP <unless> DROP <exit/></unless>
  <logN>error, xslt2-saxon-result</logN>
</def>

</forth>
